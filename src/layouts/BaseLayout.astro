---
import { siteConfig } from '@/config'
import { ClientRouter } from 'astro:transitions'
import ThemeManager from '@/components/ui/ThemeManager.astro'
import TransitionWrapper from '@/components/layout/TransitionWrapper.astro'
import type { LayoutProps } from '@/types'

type Props = LayoutProps

const { type = 'page', fullWidth = false } = Astro.props
const language = siteConfig.site.language || 'en'
const fadeAnimation = siteConfig.general.fadeAnimation
---

<html lang={language}>
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FKEHTF82T3"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-FKEHTF82T3');
    </script>
    <ThemeManager />
    {fadeAnimation && <ClientRouter />}
    <slot name="head" />
  </head>
  <body data-full-width={fullWidth}>
    {
      fadeAnimation ? (
        <TransitionWrapper type={type} class="layout-wrapper">
          <slot />
        </TransitionWrapper>
      ) : (
        <div class="layout-wrapper">
          <slot />
        </div>
      )
    }
  </body>
  <script>
    const handleExternalLinks = () => {
      document.querySelectorAll('a').forEach(link => {
        const href = link.getAttribute('href');
        if (!href) return;

        // External link criteria:
        // 1. Has a hostname (not a relative path or anchor)
        // 2. Hostname is different from current window location
        // 3. Protocol is http or https (to avoid mailto:, tel:, etc.)
        const isExternal = link.hostname && 
                          link.hostname !== window.location.hostname && 
                          (link.protocol === 'http:' || link.protocol === 'https:');
        
        if (isExternal) {
          if (!link.hasAttribute('target')) {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
          }
        } else {
          // For internal links, we don't force target="_blank".
          // If it was already set (unlikely from this script, but possible in HTML),
          // we might want to keep it if it was intentional, but most likely it wasn't.
          // However, the task is "internal moves do not open in a new window", 
          // which might imply we should remove it if it exists.
          // But usually, it's safer to just NOT add it.
        }
      });
    };

    // Execute on initial load
    handleExternalLinks();

    // Execute on Astro page transitions
    document.addEventListener('astro:page-load', () => {
      handleExternalLinks();
      // Track page view on transition
      // @ts-ignore
      if (typeof gtag === 'function') {
        // @ts-ignore
        gtag('config', 'G-FKEHTF82T3', {
          page_path: window.location.pathname
        });
      }
    });
  </script>
  <script src="@/scripts/scroll-reveal.ts"></script>
</html>

<style is:global>
  .layout-wrapper {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
</style>
